<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BTrace::blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/btrace/js/jquery.min.js"></script>
    <script src="/btrace/js/bootstrap.min.js"></script>
    <link href="/btrace/css/bootstrap.min.css" rel="stylesheet">
    <link href="/btrace/css/theme.css" rel="stylesheet">
</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/btrace/">BTrace::blog</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/btrace/">Home</a></li>
                    <li class="active visible-xs-block"><a href="/btrace/links.html">Links</a></li>
                    <li class="active"><a href="/btrace/downloads.html">Downloads</a></li>
                    <!--<li class="active"><a href="/btrace/about.html">About</a></li>-->
                    <li class="active"><a href="/btrace/archive.html">Archive</a></li>
                    <li class="active"><a href="/btrace/feed.xml">RSS</a></li>
                    
                      <li class="active"><a href="https://github.com/jbachorik/btrace">Github</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
BTrace - a safe, dynamic tracing tool for the Java platform
</div>

<div class="sidebar well">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="/btrace/2014/11/services-final">BTrace Services (Final Proposal)</a></li>
        
          <li><a href="/btrace/2014/09/extensible-services">Extensible Services for BTrace</a></li>
        
    </ul>
</div>

<div class="sidebar well">
<h1>Links</h1>
<ul>
  <li><a href="#">None yet</a></li>
</ul>

</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
                <h1><a href="/btrace/2014/09/extensible-services">Sep 10, 2014 - Extensible Services for BTrace</a></h1>
            
            <div class="post-content">
            <h1 id="history">History</h1>

<p>The ability to extend <strong>BTrace</strong> with plugins to overcome the limits imposed by its safety guarantees while still not allowing to inject any arbitrary code was requested a long time ago and is tracked as <a href="https://github.com/jbachorik/btrace/issues/29">BTRACE-64</a></p>

<h1 id="solution,-round-1">Solution, round 1</h1>

<p>The first attempt to address this problem brought many problems that were supposed to be solved by a more-or-less complete engine rewrite in <strong>BTrace 2.0</strong>. In order to make the system really extensible the modularity was baked-in to all its parts - it was possible to even extend the internal communication protocol with custom messages. </p>

<p>All of this came at a price, though. It was paid by extra nano- and micro-seconds spent in the BTrace runtime jumping through all those indirection levels.</p>

<p>Despite the availability of the <a href="https://kenai.com/projects/btrace/forums/forum/topics/523919-BTrace-2"><strong>BTrace 2.0 Preview</strong> builds</a> for quite a long time there was almost no reaction from the community. This would indicate that the <em>“rewrite from scratch”</em> approach is a deal-breaker for the majority of the users.</p>

<h1 id="rewind,-round-2">Rewind, Round 2</h1>

<h2 id="sketchup">Sketchup</h2>

<p>Instead of rewriting the engine from scratch it seems to be possible to go the way of gradual changes and improvements.</p>

<p>The main goal is to allow the users to write application specific extensions for <strong>BTrace</strong> which can be easily used just by having them on the classpath.</p>

<p>Eg. the following invocation will allow to use any <strong>BTrace</strong> extensions available in the <em>path_to_my_extension.jar</em> archive. A class is considered to be an extension if it extends a <strong>BTrace</strong> extension base class (eg. <em>com.sun.btrace.services.spi.SimpleService</em>)</p>

<h2 id="how-to-use">How to Use</h2>

<p>The following command would instruct <strong>BTrace</strong> to pickup the extensions jar.</p>

<p><code>btrace -cp ...:&lt;path_to_my_extension.jar&gt; &lt;pid&gt; &lt;tracing script&gt;</code></p>

<p>In order to use an extension one would do </p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@OnMethod</span><span class="o">(....)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handler</span><span class="o">(...)</span> <span class="o">{</span>  
  <span class="c1">// the following statement will inject the runtime  </span>
  <span class="c1">// aware service &quot;Printer&quot;  </span>
  <span class="nd">@Injected</span> <span class="n">Printer</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Service</span><span class="o">.</span><span class="na">runtime</span><span class="o">(</span><span class="n">Printer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>    
  <span class="n">p</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>As one can see it is not that different to what one was used to do before. </p>

<h2 id="why-all-this-fuzz">Why All This Fuzz</h2>

<h3 id="dsl(?)-mess-cleanup">DSL(?) Mess Cleanup</h3>

<p>Let’s face it. <strong>BTraceUtils</strong> is a dump right now. It contains any and all functions one might think as being useful when writing BTrace scripts. As the result it is rather difficult to locate the method one actually wants to use.</p>

<p>The extensions will allow for off-loading specific features of <strong>BTraceUtils</strong> leaving there only methods comprising the actual <strong>DSL</strong> (well, I might even rename the class to something more meaningful)</p>

<h3 id="integration-with-external-systems">Integration with External Systems</h3>

<p>Right now <strong>BTrace</strong> is pretty limited in how it can export the collected data - it can either write it to file or stdout. While this is sufficient for one-off scripts it is not the first choice when one wants to include <strong>BTrace</strong> in more complex systems (eg. acting as a data provider for <a href="http://riemann.io/">Riemann</a>).</p>

<h3 id="performance">Performance</h3>

<p>This implementation, in addition to not causing any performance regression, can even provide slight improvements for the runtime aware services like <strong>Printer</strong>. Each invocation of <em>print</em>/<em>println</em> will use the cached runtime as opposed to looking it up when using <strong>BTraceUtils</strong> (not using services). </p>

            </div>
            
            </div>
          </div>
          <div class="pagination">
              
                <a class="btn btn-default" href="/btrace/2014/11/services-final" class="next">Newer Post</a>
              
              
</div>

        </div>
    </div>
</div>



<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2015 BTrace::blog. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'yardus';

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>



  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55468921-2', 'auto');
    ga('send', 'pageview');
  </script>



</body>
</html>

